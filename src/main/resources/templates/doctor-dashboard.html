<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard Medico</title>
    <link rel="stylesheet" th:href="@{/css/doctor-dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- Include header -->
<header>
    <th:block th:include="fragments/header :: header"></th:block>
</header>
<main>
    <h1>Dashboard Medico</h1>

    <div class="stats">
        <div class="stat">
            <h2 th:text="${appointmentsCount}">0</h2>
            <p>Appuntamenti totali</p>
        </div>
        <div class="stat">
            <h2 th:text="${cancellationsCount}">0</h2>
            <p>Appuntamenti cancellati</p>
        </div>
        <div class="stat">
            <h2 th:text="${newPatientsCount}">0</h2>
            <p>Nuovi pazienti</p>
        </div>
        <div class="stat">
            <h2 th:text="${averageWaitingTime}">0</h2>
            <p>Tempo medio di attesa (minuti)</p>
        </div>
    </div>

    <div class="charts">
        <div class="chart" id="appointmentTypesChart">
            <h3>Tipologia di Appuntamenti</h3>
            <canvas id="appointmentTypesCanvas"></canvas>
        </div>

        <div class="chart" id="patientDemographicsChart">
            <h3>Demografia dei Pazienti</h3>
            <canvas id="patientDemographicsCanvas"></canvas>
        </div>
    </div>

    <div id="services" class="section">
        <h2>Gestisci Servizi e Prezzi</h2>
        <form id="serviceForm">
            <div>
                <label for="serviceName">Nome Servizio:</label>
                <input type="text" id="serviceName" name="serviceName" required>
            </div>
            <div>
                <label for="servicePrice">Prezzo:</label>
                <input type="number" id="servicePrice" name="servicePrice" step="0.01" required>
            </div>
            <div>
                <input type="hidden" id="serviceId" name="serviceId">
                <button type="button" onclick="saveService()">Aggiungi/Modifica Servizio</button>
            </div>
        </form>

        <h3>Lista Servizi</h3>
        <div class="services-list">
            <div class="services-list-header">
                <div class="service-name">Nome Servizio</div>
                <div class="service-price">Prezzo</div>
                <div class="service-actions">Azioni</div>
            </div>
            <div class="services-list-body" id="servicesListBody">
                <!-- Servizi saranno popolati dinamicamente -->
            </div>
        </div>
    </div>

</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var appointmentTypesData = /*[[${appointmentTypes}]]*/ {};
        var patientDemographicsData = /*[[${patientDemographics}]]*/ {};

        // Utilizza Chart.js per visualizzare i grafici
        var ctx1 = document.getElementById('appointmentTypesCanvas').getContext('2d');
        new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: Object.keys(appointmentTypesData),
                datasets: [{
                    data: Object.values(appointmentTypesData),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                }]
            }
        });

        var ctx2 = document.getElementById('patientDemographicsCanvas').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(patientDemographicsData),
                datasets: [{
                    data: Object.values(patientDemographicsData),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                }]
            }
        });

        fetchServices();
    });

    function fetchServices() {
        fetch('/services')
            .then(response => response.json())
            .then(data => {
                const servicesListBody = document.getElementById('servicesListBody');
                servicesListBody.innerHTML = '';
                data.forEach(service => {
                    const serviceItem = document.createElement('div');
                    serviceItem.classList.add('service-item');
                    serviceItem.innerHTML = `
                        <div class="service-name">${service.name}</div>
                        <div class="service-price">${service.price.toFixed(2)}</div>
                        <div class="service-actions">
                            <button onclick="editService('${service.id}', '${service.name}', ${service.price})">Modifica</button>
                            <button onclick="deleteService('${service.id}')">X</button>
                        </div>
                    `;
                    servicesListBody.appendChild(serviceItem);
                });
            });
    }

    function saveService() {
        const serviceId = document.getElementById('serviceId').value;
        const serviceName = document.getElementById('serviceName').value;
        const servicePrice = document.getElementById('servicePrice').value;

        const service = {
            name: serviceName,
            price: parseFloat(servicePrice)
        };

        let url = '/services';
        let method = 'POST';

        if (serviceId) {
            url += `/${serviceId}`;
            method = 'PUT';
        }

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(service)
        })
            .then(response => response.json())
            .then(data => {
                fetchServices();
                document.getElementById('serviceForm').reset();
                document.getElementById('serviceId').value = '';
            });
    }

    function editService(id, name, price) {
        document.getElementById('serviceId').value = id;
        document.getElementById('serviceName').value = name;
        document.getElementById('servicePrice').value = price;
    }

    function deleteService(serviceId) {
        fetch(`/services/${serviceId}`, {
            method: 'DELETE'
        })
            .then(() => {
                fetchServices();
            });
    }
</script>

<!-- Include footer -->
<footer>
    <th:block th:include="fragments/footer :: footer"></th:block>
</footer>
</body>
</html>
